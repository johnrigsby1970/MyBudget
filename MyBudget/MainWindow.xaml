<Window x:Class="MyBudget.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:MyBudget"
        xmlns:vm="clr-namespace:MyBudget.ViewModels"
        mc:Ignorable="d"
        Title="My Budget Tracker" Height="600" Width="1000">
    <Window.Resources>
        <local:NegativeToRedConverter x:Key="NegativeToRedConverter" />
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <local:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter" />
        <local:AccountTypeToVisibilityConverter x:Key="AccountTypeToVisibilityConverter" />
        <local:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
    </Window.Resources>
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        
        <Menu Grid.Row="0" Grid.ColumnSpan="2">
            <MenuItem Header="_Help">
                <MenuItem Header="_About" Command="{Binding ShowAboutCommand}" />
            </MenuItem>
        </Menu>

        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="5">
            <CheckBox x:Name="UseNewLogicCheckBox" Content="Use New Projection Logic" Margin="10,0" Checked="UseNewLogicCheckBox_Changed" Unchecked="UseNewLogicCheckBox_Changed" />
        </StackPanel>

        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*" />
                <ColumnDefinition Width="4*" />
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Bills and Paychecks -->
        <TabControl Grid.Column="0">
            <TabItem Header="Current Period">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Top" Margin="5" HorizontalAlignment="Center">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <Button Content=" &lt; " Command="{Binding PrevPeriodCommand}" Width="40" Margin="5" />
                            <TextBlock Text="{Binding PeriodDisplay}" VerticalAlignment="Center" FontWeight="Bold" FontSize="14" Margin="10,0" />
                            <Button Content=" &gt; " Command="{Binding NextPeriodCommand}" Width="40" Margin="5" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="5">
                            <CheckBox Content="Show by Month" IsChecked="{Binding ShowByMonth}" VerticalAlignment="Center" Margin="5" />
                            <ComboBox ItemsSource="{Binding PeriodPaychecks}" DisplayMemberPath="Name" SelectedValuePath="Id" 
                                      SelectedValue="{Binding SelectedPeriodPaycheckId}" Width="150" Margin="5"
                                      Visibility="{Binding ShowByMonth, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />
                        </StackPanel>
                    </StackPanel>
                    <TabControl>
                        <TabItem Header="Bills">
                            <DataGrid ItemsSource="{Binding CurrentPeriodBills}" AutoGenerateColumns="False" CanUserAddRows="False">
                                <DataGrid.Columns>
                                    <DataGridCheckBoxColumn Header="Paid" Binding="{Binding IsPaid, UpdateSourceTrigger=PropertyChanged}" Width="40" />
                                    <DataGridTextColumn Header="Bill" Binding="{Binding BillName}" IsReadOnly="True" Width="*" />
                                    <DataGridTextColumn Header="Due Date" Binding="{Binding DueDate, StringFormat=d}" IsReadOnly="True" Width="80" />
                                    <DataGridTextColumn Header="Actual Amount" Binding="{Binding ActualAmount, StringFormat=C, UpdateSourceTrigger=PropertyChanged}" Width="100" />
                                    <DataGridTemplateColumn Width="80">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Button Content="Remove" 
                                                        Command="{Binding DataContext.DeletePeriodBillCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                        CommandParameter="{Binding}"
                                                        Visibility="{Binding IsPaid, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </TabItem>
                        <TabItem Header="Buckets">
                            <DataGrid ItemsSource="{Binding CurrentPeriodBuckets}" AutoGenerateColumns="False" CanUserAddRows="False">
                                <DataGrid.Columns>
                                    <DataGridCheckBoxColumn Header="Paid" Binding="{Binding IsPaid, UpdateSourceTrigger=PropertyChanged}" Width="40" />
                                    <DataGridTextColumn Header="Bucket" Binding="{Binding BucketName}" IsReadOnly="True" Width="*" />
                                    <DataGridTextColumn Header="Actual Amount" Binding="{Binding ActualAmount, StringFormat=C, UpdateSourceTrigger=PropertyChanged}" Width="100" />
                                    <DataGridTemplateColumn Width="80">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Button Content="Remove" 
                                                        Command="{Binding DataContext.DeletePeriodBucketCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                        CommandParameter="{Binding}"
                                                        Visibility="{Binding IsPaid, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </TabItem>
                        <TabItem Header="Ad-Hoc">
                            <DockPanel>
                                <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="5">
                                    <Button Content="Add Ad-Hoc" Command="{Binding AddAdHocTransactionCommand}" Visibility="{Binding IsNotEditingAdHocTransaction, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="2" />
                                    <Button Content="Edit" Command="{Binding EditAdHocTransactionCommand}" Visibility="{Binding CanEditAdHocTransaction, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="2" />
                                </StackPanel>

                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <DataGrid Grid.Row="0" ItemsSource="{Binding CurrentPeriodAdHocTransactions}" SelectedItem="{Binding SelectedAdHocTransaction}" 
                                              AutoGenerateColumns="False" CanUserAddRows="False" IsReadOnly="True">
                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="Date" Binding="{Binding Date, StringFormat=d}" Width="80" />
                                            <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="*" />
                                            <DataGridTextColumn Header="Amount" Binding="{Binding Amount, StringFormat=C}" Width="80" />
                                            <DataGridTextColumn Header="From" Binding="{Binding AccountName}" Width="100" />
                                            <DataGridTextColumn Header="To" Binding="{Binding ToAccountName}" Width="100" />
                                            <DataGridTemplateColumn Width="80">
                                                <DataGridTemplateColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <Button Content="Remove" 
                                                                Command="{Binding DataContext.DeleteAdHocTransactionCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                                CommandParameter="{Binding}"
                                                                Visibility="{Binding DataContext.IsNotEditingAdHocTransaction, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                                    </DataTemplate>
                                                </DataGridTemplateColumn.CellTemplate>
                                            </DataGridTemplateColumn>
                                        </DataGrid.Columns>
                                    </DataGrid>

                                    <StackPanel Grid.Row="1" Margin="5" Visibility="{Binding IsEditingAdHocTransaction, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <TextBlock Text="Edit Ad-Hoc Item" FontWeight="Bold" Margin="0,5" />
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>

                                            <Label Grid.Column="0" Grid.Row="0" Content="Date:" />
                                            <DatePicker Grid.Column="1" Grid.Row="0" SelectedDate="{Binding EditingAdHocTransactionClone.Date}" Margin="5" />

                                            <Label Grid.Column="2" Grid.Row="0" Content="Description:" />
                                            <TextBox Grid.Column="3" Grid.Row="0" Text="{Binding EditingAdHocTransactionClone.Description}" Margin="5" />

                                            <Label Grid.Column="0" Grid.Row="1" Content="Amount:" />
                                            <TextBox Grid.Column="1" Grid.Row="1" Text="{Binding EditingAdHocTransactionClone.Amount, StringFormat=F2}" Margin="5" />

                                            <Label Grid.Column="2" Grid.Row="1" Content="From Account:" />
                                            <ComboBox Grid.Column="3" Grid.Row="1" ItemsSource="{Binding Accounts}" 
                                                      SelectedValue="{Binding EditingAdHocTransactionClone.AccountId}" 
                                                      SelectedValuePath="Id" DisplayMemberPath="Name" Margin="5" />

                                            <Label Grid.Column="0" Grid.Row="2" Content="To Account:" />
                                            <ComboBox Grid.Column="1" Grid.Row="2" x:Name="ToAccountComboBox" ItemsSource="{Binding Accounts}" 
                                                      SelectedValue="{Binding EditingAdHocTransactionClone.ToAccountId}" 
                                                      SelectedValuePath="Id" DisplayMemberPath="Name" Margin="5" />

                                            <Label Grid.Column="2" Grid.Row="2" Content="Bucket:" />
                                            <ComboBox Grid.Column="3" Grid.Row="2" ItemsSource="{Binding Buckets}" 
                                                      SelectedValue="{Binding EditingAdHocTransactionClone.BucketId}" 
                                                      SelectedValuePath="Id" DisplayMemberPath="Name" Margin="5" />


                                            <Label Grid.Column="0" Grid.Row="3" Content="Paycheck:" 
                                                   Visibility="{Binding EditingAdHocTransactionClone.ToAccountId, Converter={StaticResource NullToVisibilityConverter}, FallbackValue=Collapsed}"
                                                   />
                                            <ComboBox Grid.Column="1" Grid.Row="3" ItemsSource="{Binding Paychecks}"
                                                      SelectedValue="{Binding EditingAdHocTransactionClone.PaycheckId}"
                                                      SelectedValuePath="Id" DisplayMemberPath="Name" Margin="5"  
                                                      Visibility="{Binding EditingAdHocTransactionClone.ToAccountId, Converter={StaticResource NullToVisibilityConverter}, FallbackValue=Collapsed}"
                                            />

                                            <Label Grid.Column="2" Grid.Row="3" Content="Occurrence Date:"  
                                                   Visibility="{Binding EditingAdHocTransactionClone.ToAccountId, Converter={StaticResource NullToVisibilityConverter}, FallbackValue=Collapsed}"
                                            />
                                            <DatePicker Grid.Column="3" Grid.Row="3" SelectedDate="{Binding EditingAdHocTransactionClone.PaycheckOccurrenceDate}" Margin="5"  
                                                        Visibility="{Binding EditingAdHocTransactionClone.ToAccountId, Converter={StaticResource NullToVisibilityConverter}, FallbackValue=Collapsed}"
                                            />

                                            <StackPanel Grid.Column="0" Grid.Row="4" Grid.ColumnSpan="4" Orientation="Horizontal" Margin="5">
                                                <CheckBox Content="Principal Only (Mortgage/Loan Extra)" 
                                                          IsChecked="{Binding EditingAdHocTransactionClone.IsPrincipalOnly}" 
                                                          VerticalAlignment="Center" Margin="0,0,10,0"
                                                          Visibility="{Binding SelectedItem, ElementName=ToAccountComboBox, ConverterParameter='Mortgage|PersonalLoan', Converter={StaticResource AccountTypeToVisibilityConverter}, FallbackValue=Collapsed}" />
                                                <CheckBox Content="Rebalance (Adds to Debt)" 
                                                          IsChecked="{Binding EditingAdHocTransactionClone.IsRebalance}" 
                                                          VerticalAlignment="Center"
                                                          Visibility="{Binding SelectedItem, ElementName=ToAccountComboBox, ConverterParameter='Mortgage|PersonalLoan', Converter={StaticResource AccountTypeToVisibilityConverter}, FallbackValue=Collapsed}" />
                                            </StackPanel>
                                        </Grid>
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,5,0,0">
                                            <Button Content="Save" Command="{Binding SaveAdHocTransactionCommand}" Width="80" Margin="2" />
                                            <Button Content="Cancel" Command="{Binding CancelAdHocTransactionCommand}" Width="80" Margin="2" />
                                        </StackPanel>
                                    </StackPanel>
                                </Grid>
                            </DockPanel>
                        </TabItem>
                    </TabControl>
                </DockPanel>
            </TabItem>
            <TabItem Header="Buckets">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Add Bucket" Command="{Binding AddBucketCommand}" Margin="5" Width="80" />
                        <Button Content="Edit" Command="{Binding EditBucketCommand}" Margin="5" Width="80" />
                        <Button Content="Save" Command="{Binding SaveBucketCommand}" Margin="5" Width="80" />
                        <Button Content="Cancel" Command="{Binding CancelBucketCommand}" Margin="5" Width="80" />
                    </StackPanel>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <DataGrid Grid.Row="0" ItemsSource="{Binding Buckets}" SelectedItem="{Binding SelectedBucket}" 
                                  AutoGenerateColumns="False" CanUserAddRows="False" IsReadOnly="True">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="*" />
                                <DataGridTextColumn Header="Budgeted" Binding="{Binding ExpectedAmount, StringFormat=C}" Width="100" />
                            </DataGrid.Columns>
                        </DataGrid>

                        <StackPanel Grid.Row="1" Margin="10" Visibility="{Binding IsEditingBucket, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <TextBlock Text="Edit Bucket" FontWeight="Bold" Margin="0,0,0,5" />
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                
                                <Label Grid.Column="0" Content="Name:" />
                                <TextBox Grid.Column="1" Text="{Binding EditingBucketClone.Name, UpdateSourceTrigger=PropertyChanged}" Margin="5" />
                                
                                <Label Grid.Column="2" Content="Budgeted:" />
                                <TextBox Grid.Column="3" Text="{Binding EditingBucketClone.ExpectedAmount, UpdateSourceTrigger=PropertyChanged, StringFormat=F2}" Margin="5" />
                            </Grid>
                            <Grid Margin="0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <Label Content="Account:" />
                                <ComboBox Grid.Column="1" ItemsSource="{Binding Accounts}" 
                                          SelectedValue="{Binding EditingBucketClone.AccountId}" 
                                          SelectedValuePath="Id" DisplayMemberPath="Name" Margin="5" />
                            </Grid>
                        </StackPanel>
                    </Grid>
                </DockPanel>
            </TabItem>
            <TabItem Header="Bills">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Add Bill" Command="{Binding AddBillCommand}" Margin="5" Width="80" />
                        <Button Content="Edit" Command="{Binding EditBillCommand}" Margin="5" Width="80" />
                        <Button Content="Save" Command="{Binding SaveBillCommand}" Margin="5" Width="80" />
                        <Button Content="Cancel" Command="{Binding CancelBillCommand}" Margin="5" Width="80" />
                    </StackPanel>
                    
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        
                        <DataGrid Grid.Row="0" ItemsSource="{Binding Bills}" SelectedItem="{Binding SelectedBill}" 
                                  AutoGenerateColumns="False" CanUserAddRows="False" IsReadOnly="True">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="*" />
                                <DataGridTextColumn Header="Budgeted" Binding="{Binding ExpectedAmount, StringFormat=C}" Width="80" />
                                <DataGridTextColumn Header="Due Day" Binding="{Binding DueDay}" Width="60" />
                            </DataGrid.Columns>
                        </DataGrid>

                        <StackPanel Grid.Row="1" Margin="10" Visibility="{Binding IsEditingBill, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <TextBlock Text="Edit Bill" FontWeight="Bold" Margin="0,0,0,5" />
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                
                                <Label Grid.Column="0" Grid.Row="0" Content="Name:" />
                                <TextBox Grid.Column="1" Grid.Row="0" Text="{Binding EditingBillClone.Name, UpdateSourceTrigger=PropertyChanged}" Margin="5" />
                                
                                <Label Grid.Column="2" Grid.Row="0" Content="Budgeted:" />
                                <TextBox Grid.Column="3" Grid.Row="0" Text="{Binding EditingBillClone.ExpectedAmount, UpdateSourceTrigger=PropertyChanged, StringFormat=F2}" Margin="5" />
                                
                                <Label Grid.Column="0" Grid.Row="1" Content="Due Day:" />
                                <TextBox Grid.Column="1" Grid.Row="1" Text="{Binding EditingBillClone.DueDay, UpdateSourceTrigger=PropertyChanged}" Margin="5" />

                                <Label Grid.Column="2" Grid.Row="1" Content="From Account:" />
                                <ComboBox Grid.Column="3" Grid.Row="1" ItemsSource="{Binding Accounts}" 
                                          SelectedValue="{Binding EditingBillClone.AccountId}" 
                                          SelectedValuePath="Id" DisplayMemberPath="Name" Margin="5" />

                                <Label Grid.Column="0" Grid.Row="2" Content="To Account:" />
                                <ComboBox Grid.Column="1" Grid.Row="2" ItemsSource="{Binding Accounts}" 
                                          SelectedValue="{Binding EditingBillClone.ToAccountId}" 
                                          SelectedValuePath="Id" DisplayMemberPath="Name" Margin="5" />
                            </Grid>
                        </StackPanel>
                    </Grid>
                </DockPanel>
            </TabItem>
            <TabItem Header="Paychecks">
                <DockPanel>
                    <Button DockPanel.Dock="Bottom" Content="Add Paycheck" Command="{Binding AddPaycheckCommand}" Margin="5" />
                    <DataGrid ItemsSource="{Binding Paychecks}" AutoGenerateColumns="False" CanUserAddRows="False">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Name" Binding="{Binding Name, UpdateSourceTrigger=PropertyChanged}" Width="*" />
                            <DataGridTextColumn Header="Amount" Binding="{Binding ExpectedAmount, StringFormat=C, UpdateSourceTrigger=PropertyChanged}" Width="80" />
                            <DataGridTextColumn Header="Frequency" Binding="{Binding Frequency, UpdateSourceTrigger=PropertyChanged}" Width="80" />
                            <DataGridTextColumn Header="Start Date" Binding="{Binding StartDate, StringFormat=d, UpdateSourceTrigger=PropertyChanged}" Width="100" />
                            <DataGridTextColumn Header="End Date" Binding="{Binding EndDate, StringFormat=d, UpdateSourceTrigger=PropertyChanged}" Width="100" />
                            <DataGridTemplateColumn Header="Deposit To" Width="120">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <ComboBox ItemsSource="{Binding DataContext.Accounts, RelativeSource={RelativeSource AncestorType=Window}}"
                                                  DisplayMemberPath="Name" SelectedValuePath="Id"
                                                  SelectedValue="{Binding AccountId, UpdateSourceTrigger=PropertyChanged}" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridCheckBoxColumn Header="Balanced" Binding="{Binding IsBalanced, UpdateSourceTrigger=PropertyChanged}" Width="60" />
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </TabItem>
            <TabItem Header="Accounts">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Add Account" Command="{Binding AddAccountCommand}" Margin="5" Visibility="{Binding IsNotEditingAccount, Converter={StaticResource BooleanToVisibilityConverter}}" />
                        <Button Content="Edit" Command="{Binding EditAccountCommand}" Margin="5" Visibility="{Binding CanEditAccount, Converter={StaticResource BooleanToVisibilityConverter}}" />
                        <Button Content="Save" Command="{Binding SaveAccountCommand}" Margin="5" Visibility="{Binding IsEditingAccount, Converter={StaticResource BooleanToVisibilityConverter}}" />
                        <Button Content="Cancel" Command="{Binding CancelAccountCommand}" Margin="5" Visibility="{Binding IsEditingAccount, Converter={StaticResource BooleanToVisibilityConverter}}" />
                    </StackPanel>

                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <DataGrid Grid.Row="0" ItemsSource="{Binding Accounts}" SelectedItem="{Binding SelectedAccount}" AutoGenerateColumns="False" CanUserAddRows="False" IsReadOnly="True">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="*" />
                                <DataGridTextColumn Header="Bank" Binding="{Binding BankName}" Width="*" />
                                <DataGridTextColumn Header="Type" Binding="{Binding Type}" Width="100" />
                                <DataGridTextColumn Header="Balance" Binding="{Binding Balance, StringFormat=C}" Width="100" />
                                <DataGridCheckBoxColumn Header="In Total" Binding="{Binding IncludeInTotal}" Width="60" />
                                <DataGridTemplateColumn Width="80">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal">
                                                <Button Content="Remove" 
                                                        Command="{Binding DataContext.DeleteAccountCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                        CommandParameter="{Binding}" 
                                                        Visibility="{Binding DataContext.IsNotEditingAccount, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                                <Button Content="Loan" 
                                                        Command="{Binding DataContext.ShowAmortizationCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                        CommandParameter="{Binding}"
                                                        Visibility="{Binding Type, ConverterParameter=Mortgage, Converter={StaticResource AccountTypeToVisibilityConverter}}" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>

                        <StackPanel Grid.Row="1" Margin="5" Visibility="{Binding IsEditingAccount, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <TextBlock Text="Account Details" FontWeight="Bold" Margin="0,5" />
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <Label Grid.Column="0" Grid.Row="0" Content="Name:" />
                                <TextBox Grid.Column="1" Grid.Row="0" Text="{Binding EditingAccountClone.Name, UpdateSourceTrigger=PropertyChanged}" Margin="5" />

                                <Label Grid.Column="2" Grid.Row="0" Content="Bank:" />
                                <TextBox Grid.Column="3" Grid.Row="0" Text="{Binding EditingAccountClone.BankName, UpdateSourceTrigger=PropertyChanged}" Margin="5" />

                                <Label Grid.Column="0" Grid.Row="1" Content="Type:" />
                                <ComboBox Grid.Column="1" Grid.Row="1" ItemsSource="{Binding AccountTypes}" SelectedItem="{Binding EditingAccountClone.Type}" Margin="5" />

                                <Label Grid.Column="2" Grid.Row="1" Content="Balance:" />
                                <TextBox Grid.Column="3" Grid.Row="1" Text="{Binding EditingAccountClone.Balance, UpdateSourceTrigger=PropertyChanged, StringFormat=F2}" Margin="5" />

                                <Label Grid.Column="0" Grid.Row="2" Content="As Of:" />
                                <DatePicker Grid.Column="1" Grid.Row="2" SelectedDate="{Binding EditingAccountClone.BalanceAsOf}" Margin="5" />

                                <Label Grid.Column="2" Grid.Row="2" Content="Growth %:" />
                                <TextBox Grid.Column="3" Grid.Row="2" Text="{Binding EditingAccountClone.AnnualGrowthRate, UpdateSourceTrigger=PropertyChanged}" Margin="5" />

                                <CheckBox Grid.Column="3" Grid.Row="3" Content="Include In Total" IsChecked="{Binding EditingAccountClone.IncludeInTotal}" VerticalAlignment="Center" Margin="5" />
                                
                                <!-- Mortgage Specific Details -->
                                <StackPanel Grid.Row="4" Grid.ColumnSpan="4" Orientation="Horizontal" Visibility="{Binding EditingAccountClone.Type, ConverterParameter=Mortgage, Converter={StaticResource AccountTypeToVisibilityConverter}}">
                                    <Label Content="Rate %:" />
                                    <TextBox Text="{Binding EditingAccountClone.MortgageDetails.InterestRate, UpdateSourceTrigger=PropertyChanged}" Width="40" Margin="2,5" />
                                    <Label Content="Escrow:" />
                                    <TextBox Text="{Binding EditingAccountClone.MortgageDetails.Escrow, UpdateSourceTrigger=PropertyChanged}" Width="50" Margin="2,5" />
                                    <Label Content="Insurance:" />
                                    <TextBox Text="{Binding EditingAccountClone.MortgageDetails.MortgageInsurance, UpdateSourceTrigger=PropertyChanged}" Width="50" Margin="2,5" />
                                    <Label Content="Payment:" />
                                    <TextBox Text="{Binding EditingAccountClone.MortgageDetails.LoanPayment, UpdateSourceTrigger=PropertyChanged}" Width="60" Margin="2,5" />
                                    <Label Content="Date:" />
                                    <DatePicker SelectedDate="{Binding EditingAccountClone.MortgageDetails.PaymentDate, UpdateSourceTrigger=PropertyChanged}" Width="100" Margin="2,5" />
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                    </Grid>
                </DockPanel>
            </TabItem>
        </TabControl>

        <!-- Right Panel: Projections -->
        <DockPanel Grid.Column="1" Margin="10,0,0,0">
            
            <Label DockPanel.Dock="Top" Content="Financial Projection (1 Year)" FontWeight="Bold" />

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="3*" />
                    <RowDefinition Height="1*" />
                </Grid.RowDefinitions>

                <DataGrid x:Name="ProjectionGrid" Grid.Row="0" ItemsSource="{Binding Projections}" AutoGenerateColumns="False">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Date" Binding="{Binding Date, StringFormat=d}" IsReadOnly="True" Width="80" />
                        <DataGridTextColumn Header="Description" Binding="{Binding Description}" IsReadOnly="True" Width="150" />
                        <DataGridTextColumn Header="Amount" Binding="{Binding Amount, StringFormat=C, UpdateSourceTrigger=PropertyChanged}" Width="90">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="Black" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Amount, Converter={StaticResource NegativeToRedConverter}}" Value="True">
                                            <Setter Property="Foreground" Value="Red" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Total Balance" Binding="{Binding Balance, StringFormat=C}" Width="90">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="Black" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsWarning}" Value="True">
                                            <Setter Property="Foreground" Value="Red" />
                                            <Setter Property="FontWeight" Value="Bold" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Period Net" Binding="{Binding PeriodNet, StringFormat=C}" Width="90">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="FontWeight" Value="Bold" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding PeriodNet, Converter={StaticResource NegativeToRedConverter}}" Value="True">
                                            <Setter Property="Foreground" Value="Red" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>
                
                <local:ProjectionChartControl Grid.Row="1" Projections="{Binding Projections}" Accounts="{Binding Accounts}" Margin="0,5,0,0" />
            </Grid>
        </DockPanel>
    </Grid>
</Grid>
</Window>
