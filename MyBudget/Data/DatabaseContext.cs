using Dapper;
using Microsoft.Data.Sqlite;
using MyBudget.Models;
using System;
using System.IO;

namespace MyBudget.Data;

public class SqliteDecimalHandler : SqlMapper.TypeHandler<decimal>
{
    public override void SetValue(System.Data.IDbDataParameter parameter, decimal value)
    {
        parameter.Value = value;
    }

    public override decimal Parse(object value)
    {
        return Convert.ToDecimal(value);
    }
}

public class SqliteGuidHandler : SqlMapper.TypeHandler<Guid>
{
    public override void SetValue(System.Data.IDbDataParameter parameter, Guid value)
    {
        // Store as TEXT in SQLite
        parameter.Value = value.ToString();
    }

    public override Guid Parse(object value)
    {
        if (value is Guid g) return g;
        if (value is byte[] bytes && bytes.Length == 16) return new Guid(bytes);
        return Guid.Parse(value?.ToString() ?? string.Empty);
    }
}

public class SqliteNullableGuidHandler : SqlMapper.TypeHandler<Guid?>
{
    public override void SetValue(System.Data.IDbDataParameter parameter, Guid? value)
    {
        parameter.Value = value?.ToString();
    }

    public override Guid? Parse(object value)
    {
        if (value == null || value is DBNull) return null;
        if (value is Guid g) return g;
        if (value is byte[] bytes && bytes.Length == 16) return new Guid(bytes);
        var s = value.ToString();
        return string.IsNullOrWhiteSpace(s) ? null : Guid.Parse(s);
    }
}

public class DatabaseContext
{
    private readonly string _connectionString;
    
    private const string ProgramFolderName = "MyBudget";
    private const string DatabaseName = "budget.db";
    
    static DatabaseContext()
    {
        SqlMapper.AddTypeHandler(new SqliteDecimalHandler());
        SqlMapper.AddTypeHandler(new SqliteGuidHandler());
        SqlMapper.AddTypeHandler(new SqliteNullableGuidHandler());
    }

    public DatabaseContext()
    {
        var userProfileFolder = Environment.GetFolderPath(Environment.SpecialFolder.UserProfile);
        //string dbPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, DatabaseName);
        var dbFolder = Path.Combine(userProfileFolder, ProgramFolderName);
        Directory.CreateDirectory(dbFolder);
        
        var dbPath = Path.Combine(dbFolder, DatabaseName);

        _connectionString = $"Data Source={dbPath}";
        InitializeDatabase();
    }

    public SqliteConnection GetConnection() => new SqliteConnection(_connectionString);

    private void InitializeDatabase()
    {
        using var connection = GetConnection();
        connection.Open();
        
        connection.Execute(@"
            CREATE TABLE IF NOT EXISTS Accounts (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                Name TEXT NOT NULL,
                BankName TEXT,
                Balance DECIMAL NOT NULL,
                BalanceAsOf TEXT DEFAULT '2026-02-19',
                AnnualGrowthRate DECIMAL DEFAULT 0,
                IncludeInTotal INTEGER DEFAULT 1,
                Type INTEGER NOT NULL
            );

            CREATE TABLE IF NOT EXISTS MortgageDetails (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                AccountId INTEGER NOT NULL,
                InterestRate DECIMAL NOT NULL,
                Escrow DECIMAL NOT NULL,
                MortgageInsurance DECIMAL NOT NULL,
                LoanPayment DECIMAL NOT NULL,
                PaymentDate TEXT,
                FOREIGN KEY(AccountId) REFERENCES Accounts(Id)
            );

            CREATE TABLE IF NOT EXISTS Bills (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                Name TEXT NOT NULL,
                ExpectedAmount DECIMAL NOT NULL,
                Frequency INTEGER NOT NULL,
                DueDay INTEGER NOT NULL,
                AccountId INTEGER,
                ToAccountId INTEGER,
                NextDueDate TEXT,
                Category TEXT,
                IsActive INTEGER DEFAULT 1,
                FOREIGN KEY(AccountId) REFERENCES Accounts(Id),
                FOREIGN KEY(ToAccountId) REFERENCES Accounts(Id)
            );

            CREATE TABLE IF NOT EXISTS PeriodBills (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                BillId INTEGER NOT NULL,
                PeriodDate TEXT NOT NULL,
                DueDate TEXT NOT NULL,
                ActualAmount DECIMAL DEFAULT 0,
                IsPaid INTEGER DEFAULT 0,
                FitId TEXT NOT NULL,
                FOREIGN KEY(BillId) REFERENCES Bills(Id)
            );

            CREATE TABLE IF NOT EXISTS Paychecks (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                Name TEXT NOT NULL,
                ExpectedAmount DECIMAL NOT NULL,
                Frequency INTEGER NOT NULL,
                StartDate TEXT NOT NULL,
                EndDate TEXT,
                AccountId INTEGER,
                IsBalanced INTEGER DEFAULT 0,
                FOREIGN KEY(AccountId) REFERENCES Accounts(Id)
            );

            CREATE TABLE IF NOT EXISTS AdHocTransactions (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                Description TEXT,
                Amount DECIMAL NOT NULL,
                Date TEXT NOT NULL,
                AccountId INTEGER,
                ToAccountId INTEGER,
                BucketId INTEGER,
                PeriodDate TEXT NOT NULL,
                IsPrincipalOnly INTEGER DEFAULT 0,
                FitId TEXT NOT NULL,
                PaycheckId INTEGER,
                PaycheckOccurrenceDate TEXT,
                FOREIGN KEY(AccountId) REFERENCES Accounts(Id),
                FOREIGN KEY(ToAccountId) REFERENCES Accounts(Id),
                FOREIGN KEY(BucketId) REFERENCES Buckets(Id)
            );

            CREATE TABLE IF NOT EXISTS Buckets (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                Name TEXT NOT NULL,
                ExpectedAmount DECIMAL NOT NULL,
                AccountId INTEGER,
                FOREIGN KEY(PayCheckId) REFERENCES PayChecks(Id),
                FOREIGN KEY(AccountId) REFERENCES Accounts(Id)
            );

            CREATE TABLE IF NOT EXISTS PeriodBuckets (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                BucketId INTEGER NOT NULL,
                PeriodDate TEXT NOT NULL,
                ActualAmount DECIMAL DEFAULT 0,
                IsPaid INTEGER DEFAULT 0,
                FitId TEXT NOT NULL,
                FOREIGN KEY(BucketId) REFERENCES Buckets(Id)
            );
        ");
  
        var columnExists = connection.ExecuteScalar<int>(@"
            SELECT COUNT(*) FROM pragma_table_info('AdHocTransactions') WHERE name='BillId'");
        
        if (columnExists == 0)
        {
            // If the table exists but the column doesn't, add it. 
            // We check if table exists first.
            var tableExists = connection.ExecuteScalar<int>(@"
                SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='AdHocTransactions'");
            
            if (tableExists > 0)
            {
                connection.Execute("ALTER TABLE AdHocTransactions ADD COLUMN BillId INTEGER REFERENCES Bills(Id)");
            }
        }
        
        // // Check if BalanceAsOf exists in Accounts table
        // var balanceAsOfExists = connection.ExecuteScalar<int>(@"
        //     SELECT COUNT(*) FROM pragma_table_info('Accounts') WHERE name='BalanceAsOf'");
        //
        // if (balanceAsOfExists == 0)
        // {
        //     var tableExists = connection.ExecuteScalar<int>(@"
        //         SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='Accounts'");
        //     
        //     if (tableExists > 0)
        //     {
        //         connection.Execute("ALTER TABLE Accounts ADD COLUMN BalanceAsOf TEXT DEFAULT '2026-02-19'");
        //     }
        // }
        //
        // // Check if IsBalanced exists in Paychecks table
        // var isBalancedExists = connection.ExecuteScalar<int>(@"
        //     SELECT COUNT(*) FROM pragma_table_info('Paychecks') WHERE name='IsBalanced'");
        //
        // if (isBalancedExists == 0)
        // {
        //     var tableExists = connection.ExecuteScalar<int>(@"
        //         SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='Paychecks'");
        //     
        //     if (tableExists > 0)
        //     {
        //         connection.Execute("ALTER TABLE Paychecks ADD COLUMN IsBalanced INTEGER DEFAULT 0");
        //     }
        // }
        //
        // // Check if ToAccountId exists in Bills table
        // var columnExists = connection.ExecuteScalar<int>(@"
        //     SELECT COUNT(*) FROM pragma_table_info('Bills') WHERE name='ToAccountId'");
        //
        // if (columnExists == 0)
        // {
        //     // If the table exists but the column doesn't, add it. 
        //     // We check if table exists first.
        //     var tableExists = connection.ExecuteScalar<int>(@"
        //         SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='Bills'");
        //     
        //     if (tableExists > 0)
        //     {
        //         connection.Execute("ALTER TABLE Bills ADD COLUMN ToAccountId INTEGER REFERENCES Accounts(Id)");
        //     }
        // }
        //
        // // Check if IncludeInTotal exists in Accounts table
        // var includeInTotalExists = connection.ExecuteScalar<int>(@"
        //     SELECT COUNT(*) FROM pragma_table_info('Accounts') WHERE name='IncludeInTotal'");
        //
        // if (includeInTotalExists == 0)
        // {
        //     var tableExists = connection.ExecuteScalar<int>(@"
        //         SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='Accounts'");
        //     
        //     if (tableExists > 0)
        //     {
        //         connection.Execute("ALTER TABLE Accounts ADD COLUMN IncludeInTotal INTEGER DEFAULT 1");
        //     }
        // }
        //
        // // Check if PaymentDate exists in MortgageDetails table
        // var paymentDateExists = connection.ExecuteScalar<int>(@"
        //     SELECT COUNT(*) FROM pragma_table_info('MortgageDetails') WHERE name='PaymentDate'");
        //
        // if (paymentDateExists == 0)
        // {
        //     var tableExists = connection.ExecuteScalar<int>(@"
        //         SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='MortgageDetails'");
        //     
        //     if (tableExists > 0)
        //     {
        //         connection.Execute("ALTER TABLE MortgageDetails ADD COLUMN PaymentDate TEXT");
        //     }
        // }
        //
        // // Check if IsPrincipalOnly exists in AdHocTransactions table
        // var isPrincipalOnlyExists = connection.ExecuteScalar<int>(@"
        //     SELECT COUNT(*) FROM pragma_table_info('AdHocTransactions') WHERE name='IsPrincipalOnly'");
        //
        // if (isPrincipalOnlyExists == 0)
        // {
        //     var tableExists = connection.ExecuteScalar<int>(@"
        //         SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='AdHocTransactions'");
        //     
        //     if (tableExists > 0)
        //     {
        //         connection.Execute("ALTER TABLE AdHocTransactions ADD COLUMN IsPrincipalOnly INTEGER DEFAULT 0");
        //     }
        // }
        //
        // // Check if BucketId exists in AdHocTransactions table
        // var bucketIdExists = connection.ExecuteScalar<int>(@"
        //     SELECT COUNT(*) FROM pragma_table_info('AdHocTransactions') WHERE name='BucketId'");
        //
        // if (bucketIdExists == 0)
        // {
        //     var tableExists = connection.ExecuteScalar<int>(@"
        //         SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='AdHocTransactions'");
        //     
        //     if (tableExists > 0)
        //     {
        //         connection.Execute("ALTER TABLE AdHocTransactions ADD COLUMN BucketId INTEGER REFERENCES Buckets(Id)");
        //     }
        // }
        //
        // // Check if EndDate exists in Paychecks table
        // var endDateExists = connection.ExecuteScalar<int>(@"
        //     SELECT COUNT(*) FROM pragma_table_info('Paychecks') WHERE name='EndDate'");
        //
        // if (endDateExists == 0)
        // {
        //     var tableExists = connection.ExecuteScalar<int>(@"
        //         SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='Paychecks'");
        //     
        //     if (tableExists > 0)
        //     {
        //         connection.Execute("ALTER TABLE Paychecks ADD COLUMN EndDate TEXT");
        //     }
        // }
        //
        // // Check if AccountId exists in Paychecks table
        // var paycheckAccountIdExists = connection.ExecuteScalar<int>(@"
        //     SELECT COUNT(*) FROM pragma_table_info('Paychecks') WHERE name='AccountId'");
        //
        // if (paycheckAccountIdExists == 0)
        // {
        //     var tableExists = connection.ExecuteScalar<int>(@"
        //         SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='Paychecks'");
        //     
        //     if (tableExists > 0)
        //     {
        //         connection.Execute("ALTER TABLE Paychecks ADD COLUMN AccountId INTEGER REFERENCES Accounts(Id)");
        //     }
        // }
        //
        // // Ensure FITID columns exist in AdHocTransactions, PeriodBills, PeriodBuckets
        // var adHocFitIdExists = connection.ExecuteScalar<int>(@"
        //     SELECT COUNT(*) FROM pragma_table_info('AdHocTransactions') WHERE name='FitId'");
        // if (adHocFitIdExists == 0)
        // {
        //     var tableExists = connection.ExecuteScalar<int>(@"
        //         SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='AdHocTransactions'");
        //     if (tableExists > 0)
        //     {
        //         connection.Execute("ALTER TABLE AdHocTransactions ADD COLUMN FitId TEXT");
        //     }
        // }
        //
        // var periodBillFitIdExists = connection.ExecuteScalar<int>(@"
        //     SELECT COUNT(*) FROM pragma_table_info('PeriodBills') WHERE name='FitId'");
        // if (periodBillFitIdExists == 0)
        // {
        //     var tableExists = connection.ExecuteScalar<int>(@"
        //         SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='PeriodBills'");
        //     if (tableExists > 0)
        //     {
        //         connection.Execute("ALTER TABLE PeriodBills ADD COLUMN FitId TEXT");
        //     }
        // }
        //
        // var periodBucketFitIdExists = connection.ExecuteScalar<int>(@"
        //     SELECT COUNT(*) FROM pragma_table_info('PeriodBuckets') WHERE name='FitId'");
        // if (periodBucketFitIdExists == 0)
        // {
        //     var tableExists = connection.ExecuteScalar<int>(@"
        //         SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='PeriodBuckets'");
        //     if (tableExists > 0)
        //     {
        //         connection.Execute("ALTER TABLE PeriodBuckets ADD COLUMN FitId TEXT");
        //     }
        // }
        //
        // // Populate missing FITIDs for existing rows
        // var adHocIds = connection.Query<int>("SELECT Id FROM AdHocTransactions WHERE FitId IS NULL OR FitId = ''");
        // foreach (var id in adHocIds)
        // {
        //     connection.Execute("UPDATE AdHocTransactions SET FitId = @fitId WHERE Id = @id", new { id, fitId = Guid.NewGuid().ToString() });
        // }
        // var periodBillIds = connection.Query<int>("SELECT Id FROM PeriodBills WHERE FitId IS NULL OR FitId = ''");
        // foreach (var id in periodBillIds)
        // {
        //     connection.Execute("UPDATE PeriodBills SET FitId = @fitId WHERE Id = @id", new { id, fitId = Guid.NewGuid().ToString() });
        // }
        // var periodBucketIds = connection.Query<int>("SELECT Id FROM PeriodBuckets WHERE FitId IS NULL OR FitId = ''");
        // foreach (var id in periodBucketIds)
        // {
        //     connection.Execute("UPDATE PeriodBuckets SET FitId = @fitId WHERE Id = @id", new { id, fitId = Guid.NewGuid().ToString() });
        // }
        //
        // // Check if PaycheckId exists in AdHocTransactions table
        // var paycheckIdExists = connection.ExecuteScalar<int>(@"
        //     SELECT COUNT(*) FROM pragma_table_info('AdHocTransactions') WHERE name='PaycheckId'");
        //
        // if (paycheckIdExists == 0)
        // {
        //     var tableExists = connection.ExecuteScalar<int>(@"
        //         SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='AdHocTransactions'");
        //     
        //     if (tableExists > 0)
        //     {
        //         connection.Execute("ALTER TABLE AdHocTransactions ADD COLUMN PaycheckId INTEGER REFERENCES Paychecks(Id)");
        //         connection.Execute("ALTER TABLE AdHocTransactions ADD COLUMN PaycheckOccurrenceDate TEXT");
        //     }
        // }
    }
}
